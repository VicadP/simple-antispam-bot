## Описание

Телеграм-бот предназначен для автоматического обнаружения спам-сообщений и борьбы со спамом.

Бот анализирует входящие сообщения и с помощью методов машинного обучения определяет является ли сообщение спамом.

В случае, если сообщение определяется как спам, бот отправляет пользователю капчу:

- Если капча решена успешно, то пользователь добавляется в whitelist.
- Если капча решена неверно или не решена за отведеное время, то пользователь и его сообщение удаляются из чата

Бот автоматически удаляет все свои сообщения и команды пользователя с определенной задержкой, чтобы не засорять чат.

[Верхнеуровневая схема работы бота](https://drive.google.com/file/d/1SkJ79-oOiWDujZsyo201pMXKH0ZGm2np/view?usp=drive_link)

## Итоги проекта

После окончания стадии бета разработки бот был успешно развернут на сервере и запущен в одном из ТГ чатов с $\approx 400$ пользователями.

![bot_service_uptime](https://github.com/VicadP/simple-antispam-bot/blob/32ef8854a5f9485d62d6aee90a07f0f309bf8594/figures/bot_service_uptime.png) 

Бот стабильно детектирует спам сообщения, что снимает необходимость удалять спам вручную.

Метрики бота в продакшн за первую неделю работы:

- Precision: $92.6 \%$
- Recall: $95 \%$

Наличие **FP** срабатываний митигируется капчей, что позволяет избежать негативного влияния на пользователей. \
Наличие **FN** срабатываний митигируется наличием команды `/mark`, которая позволяет любому пользователю чата удалять **FN** сообщения и добавлять их в обучающую выборку.

> **Warning** \
> Бот обучался под спам сообщения конкретной группы, для поддержания генерализирующей способности может потребоваться дообучение

## Логика сканирования сообщений

Бот исполняет проверки последовательно, до первой успешной:

1. Проверка на приватный чат - бот не работает в приватном чате и уведомит об этом
2. Проверка на роль пользователя - бот не проверяет сообщения владельца и админов, а также сообщения от группы или чата
3. Проверка на длину сообщения - бот не проверяет коротки сообщения
4. Проверка на whitelist - бот не проверяет пользователей в whitelist
5. Цепочка проверок на принадлежность сообщения к спаму: доля эмодзи -> оценка классификатора

[Тест кейсы](https://docs.google.com/spreadsheets/d/1Z0lo8Fhpo4XJLWaDzazq_zDDOZsc4jiSlVh2jtjwRZ0/edit?usp=drive_link)

## Эмбединги и классификатор

Для построения эмбедингов используется [`rubert-tiny-turbo`](https://huggingface.co/sergeyzh/rubert-tiny-turbo) из [`sentence_transformers`](https://sbert.net/#).

> **Note** \
Для простоты и экономии памяти можно заменить RuBert на TfIdf, но качество будет хуже _(что может быть не критично при наличии капчи)_

В качестве классификатора используется [`LinearSVC`](https://scikit-learn.org/stable/modules/generated/sklearn.svm.LinearSVC.html). Выбор данного классификатора основан на оценке кросс-валидации (сравнивалось три модели: `GaussianNB`, `Logistic Regression`, `LinearSVC`).

Текущий классификатор обучен на небольшой выборке, состоящей из $500+$ наблюдений, с распределением классов $\approx 60/40$

## Дообучение и пересчет эмбедингов

Для того, чтобы дообучить модель достаточно запустить `./bot/model/optimize.py` и после запустить `./bot/model/train.py` с найденными параметрами. \
Для пересчета эмбедингов достаточно запустить `./bot/data/load_embeddings.py`

## Структура репозитория

```
TELEGRAM_ANTISPAM_BOT/
├── bot/
│   ├── config/             # Переменные, пороговые значения и прочие настройки
│   ├── core/               # Основные функциональные части бота: классификатор, энкодер и хэндлер
│   ├── data/               # Модули, отвественные за работу с данными, базой данных
│   ├── model/              # Модули, отвественные за оптимизацию, обучение и сохранение классификатора
├── data/                   # Данные
├── notebooks/              # Ноутбуки 
├── main.py                 # Основной скрипт для запуска бота
├── requirements_core.txt   # Основные зависимости, требуемые для работы бота
├── etc
```

## TO-DO

&#x2611; Добавить капчу для минимизации последствий ложных срабатываний \
&#x2610; Сделать логирование более информативным \
&#x2610; Добавить функционал для накопления статистики \
&#x2610; Добавить функционал для борьбы с спамом, генерируемым через LLM
