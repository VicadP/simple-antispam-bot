## Описание

Телеграм-бот предназначен для автоматического обнаружения спам-сообщений и борьбы со спамом.

Бот анализирует входящие сообщения и с помощью методов машинного обучения определяет является ли сообщение спамом. \
В случае, если сообщение определяется как спам, бот отправляет пользователю капчу:

- Если капча решена успешно, то пользователь добавляется в whitelist.
- Если капча решена неверно или не решена за отведеное время, то пользователь и его сообщение удаляются из чата

Бот автоматически удаляет все свои сообщения и команды пользователя с определенной задержкой, чтобы не засорять чат.

[Верхнеуровневая схема работы бота](https://drive.google.com/file/d/1SkJ79-oOiWDujZsyo201pMXKH0ZGm2np/view?usp=drive_link)

## Логика сканирования сообщений

Бот испольняет проверки последовательно, до первой успешной:

1. Проверка на приватный чат - бот не работает в приватном чате и уведомит об этом
2. Проверка на роль пользователя, отправившего сообщение - бот не проверяет владельца и админов
3. Проверка на длину сообщения - бот не проверяет коротки сообщения
4. Проверка на whitelist - бот не проверяет пользователей в whitelist
5. Цепочка проверок на принадлежность сообщения к спаму: доля эмодзи -> оценка классификатора -> косинусная близость

[Тест кейсы](https://docs.google.com/spreadsheets/d/1Z0lo8Fhpo4XJLWaDzazq_zDDOZsc4jiSlVh2jtjwRZ0/edit?usp=drive_link)

## Эмбединги и классификатор

Для построения эмбедингов используется [`rubert-tiny-turbo`](https://huggingface.co/sergeyzh/rubert-tiny-turbo) из [`sentence_transformers`](https://sbert.net/#).

> **Note** \
Для простоты и экономии памяти можно заменить Rubert на TfIdf, но тогда качество будет хуже _(что может быть не критично при наличии капчи)_

В качестве классификатора используется [`LinearSVC`](https://scikit-learn.org/stable/modules/generated/sklearn.svm.LinearSVC.html). Выбор данного классификатора основан на оценке кросс-валидации (сравнивалось три модели: `GaussianNB`, `Logistic Regression`, `LinearSVC`).

Текущий классификатор обучен на небольшой выборке, состоящей из $500+$ наблюдений, с распределением классов $\approx 60/40$

## Дообучение и пересчет эмбедингов

Для того, чтобы дообучить модель достаточно запустить `./bot/model/optimize.py` и после запустить `./bot/model/train.py` с найденными параметрами. \
Для пересчета эмбедингов достаточно запустить `./bot/data/load_embeddings.py`

## Структура репозитория

```
TELEGRAM_ANTISPAM_BOT/
├── bot/
│   ├── config/             # Переменные, пороговые значения и прочие настройки
│   ├── core/               # Основные функциональные части бота: классификатор, энкодер и хэндлер
│   ├── data/               # Модули, отвественные за работу с данными, базой данных
│   ├── model/              # Модули, отвественные за оптимизацию, обучение и сохранение классификатора
├── data/                   # Данные
├── notebooks/              # Ноутбуки 
├── main.py                 # Основной скрипт для запуска бота
├── requirements_core.txt   # Основные зависимости, требуемые для работы бота
├── etc
```

## TO-DO

&#x2611; Добавить капчу для спам сообщений, чтобы минимизировать FPR \
&#x2610; Упаковать все в Docker \
&#x2610; Перенести хранение данных в Postgre
